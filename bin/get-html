#!/usr/bin/env python

import requests
import re
import os
import time
from lxml import html, etree

list_url = 'http://tw-aed.mohw.gov.tw/SearchPlace.jsp?Action=Search&intPage={page_num}'
details_url = 'http://tw-aed.mohw.gov.tw/ShowPlace.jsp?PlaceID={place_id}'
tmp_filename = './tmp/{place_id}.html'

def parse_page_counter(page_counter):
    """
    Get page counter information.
    """
    page_counter_text = page_counter.findtext('.//font')
    r = re.match('當前第(\d+)頁/共(\d+)頁', page_counter_text)
    return { 'current': r.group(1), 'total': r.group(2) }

def parse_place_id(result):
    """
    Get ID from result.
    """
    return result.findtext('.//div')

def get_ids_in_list(page_num):
    """
    Get a list of IDs in the list page.
    """
    r = requests.get(list_url.format(page_num=page_num))
    if r.status_code != requests.codes.ok:
        r.raise_for_status()
    tree = html.fromstring(r.content)

    results_list, page_counter = tree.xpath('//table')[1:3]

    return {
        'counter':parse_page_counter(page_counter),
        'ids': [ parse_place_id(result)
            for result in results_list.xpath('./tr')[1:] ],
    }

def save_html(place_id):
    """
    Save HTML of the ith entry.
    """
    r = requests.get(details_url.format(place_id=place_id))
    if r.status_code != requests.codes.ok:
        r.raise_for_status()
    tree = html.fromstring(r.content.decode('utf-8'))
    with open(tmp_filename.format(place_id=place_id), 'w') as f:
        f.write(etree.tostring(tree.xpath('//div[@class="content2"]')[0], encoding='unicode'))

def main():
    page_num = 1
    while True:
        time.sleep(1)
        r = get_ids_in_list(page_num)
        if r['counter']['current'] == r['counter']['total']:
            return
        for place_id in r['ids']:
            time.sleep(1)
            save_html(place_id)
        page_num = int(r['counter']['current']) + 1

if __name__ == "__main__":
    main()
